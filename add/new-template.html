<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إضافة قالب جديد</title>
    <link rel="stylesheet" href="../style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .wd-template-layout {
        display: flex;
        gap: 20px;
        height: calc(100vh - 100px);
      }

      .wd-template-form {
        flex: 1;
        overflow-y: auto;
      }

      .wd-template-preview {
        width: 350px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .wd-preview-header {
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .wd-preview-header h3 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 18px;
      }

      .wd-preview-type {
        display: inline-block;
        padding: 4px 12px;
        background: #4a90e2;
        color: white;
        border-radius: 16px;
        font-size: 14px;
      }

      .wd-preview-content {
        flex: 1;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        overflow-y: auto;
      }

      .wd-preview-message {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-height: none;
      }

      .wd-preview-header-text {
        font-weight: bold;
        color: #000;
      }

      .wd-preview-body {
        font-size: 14px;
        color: #000;
        margin: 10px 0;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .wd-preview-footer {
        font-size: 12px;
        margin-top: 10px;
        padding-top: 10px;
        color: #666;
      }

      .wd-preview-image {
        max-width: 100%;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 240px;
        height: 130px;
        object-fit: cover;
      }

      .wd-preview-buttons {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 0 10px;
      }

      .wd-preview-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 12px;
        background: #25d366;
        color: white;
        border: none;
        border-radius: 2px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.3s ease;
        height: 32px;
        margin: 2px 0;
      }

      .wd-preview-button i {
        margin-left: 6px;
        font-size: 14px;
      }

      .wd-preview-button span {
        font-size: 14px;
      }

      .wd-preview-button:hover {
        background: #128c7e;
      }

      .wd-form-section {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .wd-section-title {
        margin: 0 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        color: #333;
        font-size: 18px;
      }

      .wd-form-group {
        margin-bottom: 20px;
      }

      .wd-form-group:last-child {
        margin-bottom: 0;
      }

      .wd-action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .wd-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wd-btn-secondary {
        background: #f8f9fa;
        border: 1px solid #ddd;
        color: #333;
      }

      .wd-btn-secondary:hover {
        background: #e9ecef;
      }

      .wd-btn-primary {
        background: #4a90e2;
        border: none;
        color: white;
      }

      .wd-btn-primary:hover {
        background: #357abd;
      }

      .wd-variables-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .wd-variables-section h4 {
        margin: 0 0 15px 0;
        color: #333;
      }

      .wd-variables-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .wd-variable-item {
        background: #e9ecef;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wd-variable-item:hover {
        background: #dee2e6;
      }

      .wd-form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }

      /* إضافة أنماط جديدة */
      .wd-preview-frame {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        text-align: center;
        background: #f8f9fa;
        display: none;
      }

      .wd-preview-frame img,
      .wd-preview-frame video {
        max-width: 100%;
        max-height: 200px;
        border-radius: 4px;
      }

      .wd-preview-frame .wd-file-icon {
        font-size: 48px;
        color: #666;
        margin: 10px 0;
      }

      .wd-preview-frame .wd-location-icon {
        font-size: 24px;
        color: #4a90e2;
        margin-right: 8px;
      }

      .wd-optional {
        color: #666;
        font-size: 14px;
        margin-right: 5px;
      }

      .wd-buttons-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        color: #666;
        font-size: 14px;
        line-height: 1.5;
      }

      .wd-text-controls {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .wd-text-controls button {
        padding: 6px 10px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wd-text-controls button:hover {
        background: #e9ecef;
      }

      .wd-text-controls button.active {
        background: #4a90e2;
        color: white;
        border-color: #4a90e2;
      }

      /* أنماط السحب والإفلات */
      .wd-draggable-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .wd-button-group {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        cursor: move;
        transition: all 0.3s ease;
      }

      .wd-button-group:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .wd-button-group.dragging {
        opacity: 0.5;
        border: 2px dashed #4a90e2;
      }

      .wd-button-group .wd-button-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .wd-button-group .wd-button-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
      }

      .wd-button-group .wd-button-actions {
        display: flex;
        gap: 8px;
      }

      .wd-button-group .wd-button-action {
        padding: 4px 8px;
        border: none;
        background: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .wd-button-group .wd-button-action:hover {
        background: #e9ecef;
      }

      .wd-button-group .wd-button-action.delete {
        color: #dc3545;
      }

      .wd-button-group .wd-button-action.delete:hover {
        background: #dc3545;
        color: white;
      }

      .wd-form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .wd-form-col {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .wd-form-col.button-text {
        flex: 1;
      }

      .wd-form-col.button-value {
        flex: 3;
      }

      /* إضافة أنماط جديدة للعدادات */
      .wd-char-counter {
        font-size: 12px;
        color: #666;
        text-align: left;
        margin-top: 5px;
      }

      .wd-char-counter.error {
        color: #dc3545;
      }

      /* إضافة أنماط جديدة للمعاينة */
      .wd-preview-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .wd-preview-name {
        font-weight: 500;
        color: #333;
      }

      .wd-preview-language {
        color: #666;
        font-size: 14px;
      }

      .wd-preview-type {
        display: inline-block;
        padding: 4px 12px;
        background: #4a90e2;
        color: white;
        border-radius: 16px;
        font-size: 14px;
      }

      .wd-preview-type.marketing {
        background: #4a90e2;
      }

      .wd-preview-type.utility {
        background: #28a745;
      }

      .wd-preview-type.authentication {
        background: #dc3545;
      }

      .wd-preview-type.carousel {
        background: #ffc107;
        color: #333;
      }
    </style>
  </head>

  <body>
    <div class="wd-container">
      <!-- القسم الأول: القائمة الجانبية -->
      <aside class="wd-sidebar">
        <div class="wd-logo">
          <img src="../imgs/logo.png" alt="شعار المنصة" />
        </div>
        <nav class="wd-nav">
          <ul>
            <li class="wd-nav-item">
              <i class="fa-solid fa-gauge"></i>
              <span
                ><a href="../index.html" class="wd-nav-link"
                  >لوحة التحكم</a
                ></span
              >
            </li>
            <li class="wd-nav-item">
              <i class="fa-solid fa-comments"></i>
              <span
                ><a href="../chat.html" class="wd-nav-link">المحادثات</a></span
              >
            </li>
            <li class="wd-nav-item">
              <i class="fa-solid fa-users"></i>
              <span
                ><a href="../contacts.html" class="wd-nav-link"
                  >جهات الاتصال</a
                ></span
              >
            </li>
            <li class="wd-nav-item">
              <i class="fa-solid fa-diagram-project"></i>
              <span
                ><a href="../flows.html" class="wd-nav-link">التدفقات</a></span
              >
            </li>
            <li class="wd-nav-item">
              <i class="fas fa-bullhorn"></i>
              <span
                ><a href="../campaigns.html" class="wd-nav-link"
                  >الحملات</a
                ></span
              >
            </li>
            <li class="wd-nav-item">
              <i class="fas fa-calendar"></i>
              <span
                ><a href="../calendar.html" class="wd-nav-link"
                  >التقويم</a
                ></span
              >
            </li>
            <li class="wd-nav-item">
              <i class="fas fa-file-alt"></i>
              <span
                ><a href="../contents.html" class="wd-nav-link"
                  >المحتويات</a
                ></span
              >
            </li>
            <li class="wd-nav-item">
              <i class="fas fa-code"></i>
              <span
                ><a href="../developers.html" class="wd-nav-link"
                  >المطورين</a
                ></span
              >
            </li>
            <li class="wd-nav-item">
              <i class="fas fa-cog"></i>
              <span
                ><a href="../settings.html" class="wd-nav-link"
                  >الإعدادات</a
                ></span
              >
            </li>
          </ul>
        </nav>
      </aside>

      <!-- القسم الثاني: المحتوى الرئيسي -->
      <main class="wd-main-content" style="right: 65px">
        <div class="wd-content-header" style="right: 65px">
          <div class="wd-header-left">
            <button
              class="wd-back-btn"
              onclick="window.location.href='../contents.html'"
            >
              <i class="fas fa-arrow-right"></i>
            </button>
            <h1>إضافة قالب جديد</h1>
          </div>
        </div>

        <div class="wd-content-body" style="right: 65px">
          <div class="wd-template-layout">
            <div class="wd-template-form">
              <!-- قسم اسم، لغة وفئة القالب -->
              <div class="wd-form-section">
                <h3 class="wd-section-title">اسم، لغة وفئة القالب</h3>
                <div class="wd-form-group">
                  <label for="templateName"
                    >اسم القالب <span class="wd-required">*</span></label
                  >
                  <input
                    type="text"
                    id="templateName"
                    class="wd-form-control"
                    placeholder="أدخل اسم القالب (أحرف إنجليزية و _ فقط)"
                    oninput="validateTemplateName(this)"
                    maxlength="512"
                    pattern="[A-Za-z_]+"
                    title="يجب أن يحتوي اسم القالب على أحرف إنجليزية و _ فقط"
                  />
                  <div class="wd-char-counter" id="templateNameCounter">
                    0/512
                  </div>
                  <div class="wd-error-message" id="templateNameError"></div>
                </div>

                <div class="wd-form-group">
                  <label for="templateType"
                    >نوع القالب <span class="wd-required">*</span></label
                  >
                  <select
                    id="templateType"
                    class="wd-form-control"
                    onchange="updateTemplatePreview()"
                  >
                    <option value="">اختر فئة القالب</option>
                    <option value="marketing">MARKETING</option>
                    <option value="utility">UTILITY</option>
                    <option value="authentication">AUTHENTICATION</option>
                    <option value="carousel">CAROUSEL</option>
                  </select>
                  <div class="wd-error-message" id="templateTypeError"></div>
                </div>

                <div class="wd-form-group">
                  <label for="templateLanguage"
                    >اللغة <span class="wd-required">*</span></label
                  >
                  <select
                    id="templateLanguage"
                    class="wd-form-control"
                    onchange="updateTemplatePreview()"
                  >
                    <option value="">اختر لغة القالب</option>
                    <option value="af">Afrikaans</option>
                    <option value="sq">Albanian</option>
                    <option value="ar">Arabic</option>
                    <option value="az">Azerbaijani</option>
                    <option value="bn">Bengali</option>
                    <option value="bg">Bulgarian</option>
                    <option value="ca">Catalan</option>
                    <option value="zh_CN">Chinese (CHN)</option>
                    <option value="zh_HK">Chinese (HKG)</option>
                    <option value="zh_TW">Chinese (TAI)</option>
                    <option value="hr">Croatian</option>
                    <option value="cs">Czech</option>
                    <option value="da">Danish</option>
                    <option value="nl">Dutch</option>
                    <option value="en">English</option>
                    <option value="en_GB">English (UK)</option>
                    <option value="en_US">English (US)</option>
                    <option value="et">Estonian</option>
                    <option value="fil">Filipino</option>
                    <option value="fi">Finnish</option>
                    <option value="fr">French</option>
                    <option value="ka">Georgian</option>
                    <option value="de">German</option>
                    <option value="el">Greek</option>
                    <option value="gu">Gujarati</option>
                    <option value="ha">Hausa</option>
                    <option value="he">Hebrew</option>
                    <option value="hi">Hindi</option>
                    <option value="hu">Hungarian</option>
                    <option value="id">Indonesian</option>
                    <option value="ga">Irish</option>
                    <option value="it">Italian</option>
                    <option value="ja">Japanese</option>
                    <option value="kn">Kannada</option>
                    <option value="kk">Kazakh</option>
                    <option value="ky_KG">Kyrgyz (Kyrgyzstan)</option>
                    <option value="lo">Lao</option>
                    <option value="lv">Latvian</option>
                    <option value="lt">Lithuanian</option>
                    <option value="mk">Macedonian</option>
                    <option value="ms">Malay</option>
                    <option value="ml">Malayalam</option>
                    <option value="mr">Marathi</option>
                    <option value="nb">Norwegian</option>
                    <option value="fa">Persian</option>
                    <option value="pl">Polish</option>
                    <option value="pt_BR">Portuguese (BR)</option>
                    <option value="pt_PT">Portuguese (POR)</option>
                    <option value="pa">Punjabi</option>
                    <option value="ro">Romanian</option>
                    <option value="ru">Russian</option>
                    <option value="sr">Serbian</option>
                    <option value="sk">Slovak</option>
                    <option value="sl">Slovenian</option>
                    <option value="es">Spanish</option>
                    <option value="es_AR">Spanish (ARG)</option>
                    <option value="es_ES">Spanish (SPA)</option>
                    <option value="es_MX">Spanish (MEX)</option>
                    <option value="sw">Swahili</option>
                    <option value="sv">Swedish</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                    <option value="th">Thai</option>
                    <option value="tr">Turkish</option>
                    <option value="uk">Ukrainian</option>
                    <option value="ur">Urdu</option>
                    <option value="uz">Uzbek</option>
                    <option value="vi">Vietnamese</option>
                    <option value="zu">Zulu</option>
                  </select>
                  <div
                    class="wd-error-message"
                    id="templateLanguageError"
                  ></div>
                </div>
              </div>

              <!-- قسم المحتوى -->
              <div class="wd-form-section">
                <h3 class="wd-section-title">المحتوى</h3>
                <div class="wd-form-group">
                  <label for="templateHeader"
                    >رأس الرسالة
                    <span class="wd-optional">· اختياري</span></label
                  >
                  <select
                    id="templateHeader"
                    class="wd-form-control"
                    onchange="handleHeaderChange()"
                  >
                    <option value="none">بدون</option>
                    <option value="text">نص</option>
                    <option value="image">صورة</option>
                    <option value="video">فيديو</option>
                    <option value="document">ملف</option>
                    <option value="location">موقع</option>
                  </select>
                </div>

                <!-- حقول رأس الرسالة -->
                <div id="headerFields" style="display: none">
                  <div
                    class="wd-form-group"
                    id="headerTextGroup"
                    style="display: none"
                  >
                    <label for="headerText">نص الرأس</label>
                    <input
                      type="text"
                      id="headerText"
                      class="wd-form-control"
                      placeholder="أدخل نص الرأس"
                      oninput="updateTemplatePreview()"
                      maxlength="60"
                    />
                    <div class="wd-char-counter" id="headerTextCounter">
                      0/60
                    </div>
                  </div>

                  <div
                    class="wd-form-group"
                    id="headerImageGroup"
                    style="display: none"
                  >
                    <label for="headerImage">صورة الرأس</label>
                    <input
                      type="file"
                      id="headerImage"
                      class="wd-form-control"
                      accept="image/*"
                      onchange="updateTemplatePreview()"
                    />
                  </div>

                  <div
                    class="wd-form-group"
                    id="headerVideoGroup"
                    style="display: none"
                  >
                    <label for="headerVideo">فيديو الرأس</label>
                    <input
                      type="file"
                      id="headerVideo"
                      class="wd-form-control"
                      accept="video/*"
                      onchange="updateTemplatePreview()"
                    />
                  </div>

                  <div
                    class="wd-form-group"
                    id="headerDocumentGroup"
                    style="display: none"
                  >
                    <label for="headerDocument">ملف الرأس</label>
                    <input
                      type="file"
                      id="headerDocument"
                      class="wd-form-control"
                      onchange="updateTemplatePreview()"
                    />
                  </div>

                  <div
                    class="wd-form-group"
                    id="headerLocationGroup"
                    style="display: none"
                  >
                    <label for="headerLocation">موقع الرأس</label>
                    <input
                      type="text"
                      id="headerLocation"
                      class="wd-form-control"
                      placeholder="أدخل عنوان الموقع"
                      oninput="updateTemplatePreview()"
                    />
                  </div>
                </div>

                <div class="wd-form-group">
                  <label for="templateContent"
                    >محتوى القالب <span class="wd-required">*</span></label
                  >
                  <div class="wd-text-controls">
                    <button onclick="formatText('emoji')" title="إضافة إيموجي">
                      <i class="far fa-smile"></i>
                    </button>
                    <button onclick="formatText('bold')" title="نص عريض">
                      <i class="fas fa-bold"></i>
                    </button>
                    <button onclick="formatText('italic')" title="نص مائل">
                      <i class="fas fa-italic"></i>
                    </button>
                    <button
                      onclick="formatText('strikethrough')"
                      title="يتوسطه خط"
                    >
                      <i class="fas fa-strikethrough"></i>
                    </button>
                    <button
                      onclick="formatText('spacing')"
                      title="تعديل المسافات"
                    >
                      <i class="fas fa-text-width"></i>
                    </button>
                    <button onclick="showVariables()" title="إضافة متغير">
                      <i class="fas fa-code"></i>
                    </button>
                  </div>
                  <textarea
                    id="templateContent"
                    class="wd-form-control"
                    rows="6"
                    placeholder="أدخل محتوى القالب"
                    oninput="updateTemplatePreview()"
                    maxlength="1024"
                  ></textarea>
                  <div class="wd-char-counter" id="templateContentCounter">
                    0/1024
                  </div>
                  <div class="wd-error-message" id="templateContentError"></div>
                </div>

                <div class="wd-form-group">
                  <label for="templateFooter"
                    >تذييل الرسالة
                    <span class="wd-optional">· اختياري</span></label
                  >
                  <textarea
                    id="templateFooter"
                    class="wd-form-control"
                    rows="2"
                    placeholder="أدخل تذييل الرسالة"
                    oninput="updateTemplatePreview()"
                    maxlength="60"
                  ></textarea>
                  <div class="wd-char-counter" id="templateFooterCounter">
                    0/60
                  </div>
                </div>
              </div>

              <!-- قسم الأزرار -->
              <div class="wd-form-section">
                <h3 class="wd-section-title">الأزرار</h3>
                <div class="wd-buttons-info">
                  يمكنك إنشاء أزرار تتيح للعملاء الرد على رسالتك أو اتخاذ إجراء.
                  يمكنك إضافة ما يصل إلى 10 أزرار. وفي حالة إضافة أكثر من 3
                  أزرار، ستظهر في قائمة.
                </div>
                <div class="wd-form-group">
                  <label
                    >أزرار الإجراءات
                    <span class="wd-optional">· اختياري</span></label
                  >
                  <div class="wd-action-buttons">
                    <button
                      type="button"
                      class="wd-btn wd-btn-secondary"
                      onclick="addQuickReplyButton()"
                      id="addQuickReplyBtn"
                    >
                      <i class="fas fa-reply"></i>
                      + رد سريع
                    </button>
                    <button
                      type="button"
                      class="wd-btn wd-btn-secondary"
                      onclick="addLinkButton()"
                      id="addLinkBtn"
                    >
                      <i class="fas fa-link"></i>
                      + رابط
                    </button>
                    <button
                      type="button"
                      class="wd-btn wd-btn-secondary"
                      onclick="addPhoneButton()"
                      id="addPhoneBtn"
                    >
                      <i class="fas fa-phone"></i>
                      + هاتف
                    </button>
                    <button
                      type="button"
                      class="wd-btn wd-btn-secondary"
                      onclick="addCopyButton()"
                      id="addCopyBtn"
                    >
                      <i class="fas fa-copy"></i>
                      + نسخ رمز
                    </button>
                  </div>
                </div>

                <!-- حقول الأزرار -->
                <div
                  id="buttonFields"
                  class="wd-draggable-container"
                  style="display: none"
                >
                  <!-- سيتم إضافة حقول الأزرار هنا -->
                </div>
              </div>

              <div class="wd-form-actions">
                <button
                  class="wd-btn wd-btn-secondary"
                  onclick="window.location.href='../contents.html'"
                >
                  إلغاء
                </button>
                <button
                  class="wd-btn wd-btn-primary"
                  onclick="createTemplate()"
                >
                  إنشاء القالب
                </button>
              </div>
            </div>

            <div class="wd-template-preview">
              <div class="wd-preview-header">
                <h3>معاينة القالب</h3>
                <span class="wd-preview-type" id="previewType">فئة القالب</span>
              </div>
              <div class="wd-preview-content" id="previewContent">
                <div
                  class="wd-preview-frame"
                  id="headerPreview"
                  style="display: none"
                >
                  <!-- سيتم عرض معاينة الرأس هنا -->
                </div>
                <div class="wd-preview-message">
                  <!-- سيتم عرض محتوى الرسالة هنا -->
                </div>
                <div class="wd-preview-buttons">
                  <!-- سيتم عرض الأزرار هنا -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script src="../script.js"></script>
    <script>
      function handleHeaderChange() {
        const headerType = document.getElementById("templateHeader").value;
        const headerFields = document.getElementById("headerFields");

        // إخفاء جميع حقول الرأس
        document
          .querySelectorAll("#headerFields .wd-form-group")
          .forEach((group) => {
            group.style.display = "none";
          });

        if (headerType !== "none") {
          headerFields.style.display = "block";
          document.getElementById(
            `header${
              headerType.charAt(0).toUpperCase() + headerType.slice(1)
            }Group`
          ).style.display = "block";

          if (headerType === "text") {
            const headerText = document.getElementById("headerText");
            headerText.addEventListener("input", function () {
              updateCharCounter(this, "headerTextCounter", 60);
              updateTemplatePreview();
            });
          }
        } else {
          headerFields.style.display = "none";
        }

        updateTemplatePreview();
      }

      function updateTemplatePreview() {
        const headerType = document.getElementById("templateHeader").value;
        const content = document.getElementById("templateContent");
        const footer = document.getElementById("templateFooter");
        const templateName = document.getElementById("templateName").value;
        const templateType = document.getElementById("templateType").value;
        const templateLanguage =
          document.getElementById("templateLanguage").value;

        // تحديث عدادات الأحرف
        updateCharCounter(content, "templateContentCounter", 1024);
        updateCharCounter(footer, "templateFooterCounter", 60);

        // تحديث معلومات القالب في المعاينة
        const previewHeader = document.querySelector(".wd-preview-header");
        previewHeader.innerHTML = `
          <div class="wd-preview-info">
            <div class="wd-preview-name">${templateName || "اسم القالب"}</div>
            <div class="wd-preview-language">${
              getLanguageName(templateLanguage) || "اللغة"
            }</div>
          </div>
          <span class="wd-preview-type ${templateType}">${getTemplateTypeName(
          templateType
        )}</span>
        `;

        let previewHTML = "";

        // إضافة الرأس
        if (headerType !== "none") {
          let headerContent = "";
          switch (headerType) {
            case "text":
              headerContent = document.getElementById("headerText").value;
              if (headerContent) {
                previewHTML += `<div class="wd-preview-header-text">${headerContent}</div>`;
              }
              break;
            case "image":
              const imageFile = document.getElementById("headerImage").files[0];
              if (imageFile) {
                const imageUrl = URL.createObjectURL(imageFile);
                headerContent = `<img src="${imageUrl}" alt="معاينة الصورة" class="wd-preview-image">`;
                headerPreview.style.display = "none";
              } else {
                headerContent =
                  '<i class="fas fa-image wd-file-icon"></i><br>لم يتم اختيار صورة';
                headerPreview.style.display = "block";
              }
              break;
            case "video":
              const videoFile = document.getElementById("headerVideo").files[0];
              if (videoFile) {
                const videoUrl = URL.createObjectURL(videoFile);
                headerContent = `<video src="${videoUrl}" controls></video>`;
                headerPreview.style.display = "none";
              } else {
                headerContent =
                  '<i class="fas fa-video wd-file-icon"></i><br>لم يتم اختيار فيديو';
                headerPreview.style.display = "block";
              }
              break;
            case "document":
              const docFile =
                document.getElementById("headerDocument").files[0];
              if (docFile) {
                headerContent = `<i class="fas fa-file wd-file-icon"></i><br>${docFile.name}`;
                headerPreview.style.display = "none";
              } else {
                headerContent =
                  '<i class="fas fa-file wd-file-icon"></i><br>لم يتم اختيار ملف';
                headerPreview.style.display = "block";
              }
              break;
            case "location":
              const location = document.getElementById("headerLocation").value;
              if (location) {
                headerContent = `<i class="fas fa-map-marker-alt wd-location-icon"></i>${location}`;
                headerPreview.style.display = "none";
              } else {
                headerContent =
                  '<i class="fas fa-map-marker-alt wd-location-icon"></i>لم يتم تحديد الموقع';
                headerPreview.style.display = "block";
              }
              break;
          }

          if (headerType !== "text") {
            headerPreview.innerHTML = headerContent;
            headerPreview.style.display = "block";
          } else {
            headerPreview.style.display = "none";
          }
        } else {
          headerPreview.style.display = "none";
        }

        // إضافة المحتوى مع الحفاظ على المسافات بين الأسطر
        if (content.value) {
          let formattedContent = content.value.replace(/\n/g, "<br>");
          previewHTML += `<div class="wd-preview-body">${formattedContent}</div>`;
        }

        // إضافة التذييل
        if (footer.value) {
          let formattedFooter = footer.value.replace(/\n/g, "<br>");
          previewHTML += `<div class="wd-preview-footer">${formattedFooter}</div>`;
        }

        // إضافة الأزرار
        const buttonFields = document.getElementById("buttonFields");
        if (buttonFields && buttonFields.children.length > 0) {
          let buttonsHTML = '<div class="wd-preview-buttons">';

          Array.from(buttonFields.children).forEach((buttonGroup) => {
            const type = buttonGroup.id.split("_")[0];
            let buttonHTML = "";

            switch (type) {
              case "phone":
                const phoneText = document.getElementById(
                  `phoneButtonText_${buttonGroup.id}`
                ).value;
                const phoneNumber = document.getElementById(
                  `phoneNumber_${buttonGroup.id}`
                ).value;
                if (phoneText && phoneNumber) {
                  buttonHTML = `
                    <button class="wd-preview-button">
                      <i class="fas fa-phone"></i>
                      ${phoneText}
                    </button>
                  `;
                }
                break;

              case "link":
                const linkText = document.getElementById(
                  `linkButtonText_${buttonGroup.id}`
                ).value;
                const linkUrl = document.getElementById(
                  `linkUrl_${buttonGroup.id}`
                ).value;
                if (linkText && linkUrl) {
                  buttonHTML = `
                    <button class="wd-preview-button">
                      <i class="fas fa-link"></i>
                      ${linkText}
                    </button>
                  `;
                }
                break;

              case "copy":
                const copyText = document.getElementById(
                  `copyButtonText_${buttonGroup.id}`
                ).value;
                const copyCode = document.getElementById(
                  `copyCode_${buttonGroup.id}`
                ).value;
                if (copyText && copyCode) {
                  buttonHTML = `
                    <button class="wd-preview-button">
                      <i class="fas fa-copy"></i>
                      ${copyText}
                    </button>
                  `;
                }
                break;

              case "quickReply":
                const quickReplyText = document.getElementById(
                  `quickReplyButtonText_${buttonGroup.id}`
                ).value;
                const replyText = document.getElementById(
                  `quickReplyText_${buttonGroup.id}`
                ).value;
                if (quickReplyText && replyText) {
                  buttonHTML = `
                    <button class="wd-preview-button">
                      <i class="fas fa-reply"></i>
                      ${quickReplyText}
                    </button>
                  `;
                }
                break;
            }

            if (buttonHTML) {
              buttonsHTML += buttonHTML;
            }
          });

          buttonsHTML += "</div>";
          previewHTML += buttonsHTML;
        }

        document.querySelector(".wd-preview-message").innerHTML = previewHTML;
      }

      function formatText(type) {
        const content = document.getElementById("templateContent");
        const start = content.selectionStart;
        const end = content.selectionEnd;
        const text = content.value;
        let newText = "";

        switch (type) {
          case "emoji":
            newText = text.substring(0, start) + "😊" + text.substring(end);
            break;
          case "bold":
            newText =
              text.substring(0, start) +
              "*" +
              text.substring(start, end) +
              "*" +
              text.substring(end);
            break;
          case "italic":
            newText =
              text.substring(0, start) +
              "_" +
              text.substring(start, end) +
              "_" +
              text.substring(end);
            break;
          case "strikethrough":
            newText =
              text.substring(0, start) +
              "~" +
              text.substring(start, end) +
              "~" +
              text.substring(end);
            break;
          case "spacing":
            newText =
              text.substring(0, start) +
              "  " +
              text.substring(start, end) +
              "  " +
              text.substring(end);
            break;
        }

        content.value = newText;
        updateTemplatePreview();
      }

      function showVariables() {
        // يمكن إضافة نافذة منبثقة لعرض المتغيرات المتاحة
        const variables = ["{{name}}", "{{company}}", "{{date}}", "{{time}}"];
        let html = '<div class="wd-variables-popup">';
        variables.forEach((variable) => {
          html += `<div class="wd-variable-item" onclick="insertVariable('${variable}')">${variable}</div>`;
        });
        html += "</div>";
        // يمكن إضافة كود لعرض النافذة المنبثقة
      }

      let buttonCounts = {
        phone: 0,
        link: 0,
        copy: 0,
        quickReply: 0,
        total: 0,
      };

      function createButtonGroup(type, id) {
        const buttonGroup = document.createElement("div");
        buttonGroup.className = "wd-button-group";
        buttonGroup.id = id;
        buttonGroup.draggable = true;

        let headerContent = "";
        let fieldsContent = "";

        switch (type) {
          case "phone":
            headerContent = `
              <div class="wd-button-title">
                <i class="fas fa-phone"></i>
                زر الهاتف
              </div>
            `;
            fieldsContent = `
              <div class="wd-form-row">
                <div class="wd-form-col button-text">
                  <label for="phoneButtonText_${id}">نص زر الهاتف</label>
                  <input
                    type="text"
                    id="phoneButtonText_${id}"
                    class="wd-form-control"
                    placeholder="أدخل نص الزر"
                    oninput="updateTemplatePreview()"
                    maxlength="25"
                  />
                  <div class="wd-char-counter" id="phoneButtonTextCounter_${id}">0/25</div>
                </div>
                <div class="wd-form-col button-value">
                  <label for="phoneNumber_${id}">رقم الهاتف</label>
                  <input
                    type="tel"
                    id="phoneNumber_${id}"
                    class="wd-form-control"
                    placeholder="أدخل رقم الهاتف"
                    oninput="updateTemplatePreview()"
                    maxlength="20"
                  />
                  <div class="wd-char-counter" id="phoneNumberCounter_${id}">0/20</div>
                </div>
              </div>
            `;
            break;
          case "link":
            headerContent = `
              <div class="wd-button-title">
                <i class="fas fa-link"></i>
                زر الرابط
              </div>
            `;
            fieldsContent = `
              <div class="wd-form-row">
                <div class="wd-form-col button-text">
                  <label for="linkButtonText_${id}">نص زر الرابط</label>
                  <input
                    type="text"
                    id="linkButtonText_${id}"
                    class="wd-form-control"
                    placeholder="أدخل نص الزر"
                    oninput="updateTemplatePreview()"
                    maxlength="25"
                  />
                  <div class="wd-char-counter" id="linkButtonTextCounter_${id}">0/25</div>
                </div>
                <div class="wd-form-col button-value">
                  <label for="linkUrl_${id}">الرابط</label>
                  <input
                    type="url"
                    id="linkUrl_${id}"
                    class="wd-form-control"
                    placeholder="أدخل الرابط"
                    oninput="updateTemplatePreview()"
                    maxlength="2000"
                  />
                  <div class="wd-char-counter" id="linkUrlCounter_${id}">0/2000</div>
                </div>
              </div>
            `;
            break;
          case "copy":
            headerContent = `
              <div class="wd-button-title">
                <i class="fas fa-copy"></i>
                زر نسخ الرمز
              </div>
            `;
            fieldsContent = `
              <div class="wd-form-row">
                <div class="wd-form-col button-text">
                  <label for="copyButtonText_${id}">نص زر نسخ الرمز</label>
                  <input
                    type="text"
                    id="copyButtonText_${id}"
                    class="wd-form-control"
                    placeholder="أدخل نص الزر"
                    oninput="updateTemplatePreview()"
                  />
                </div>
                <div class="wd-form-col button-value">
                  <label for="copyCode_${id}">رمز العرض</label>
                  <input
                    type="text"
                    id="copyCode_${id}"
                    class="wd-form-control"
                    placeholder="أدخل رمز العرض"
                    oninput="updateTemplatePreview()"
                  />
                </div>
              </div>
            `;
            break;
          case "quickReply":
            headerContent = `
              <div class="wd-button-title">
                <i class="fas fa-reply"></i>
                زر الرد السريع
              </div>
            `;
            fieldsContent = `
              <div class="wd-form-row">
                <div class="wd-form-col button-text">
                  <label for="quickReplyButtonText_${id}">نص زر الرد السريع</label>
                  <input
                    type="text"
                    id="quickReplyButtonText_${id}"
                    class="wd-form-control"
                    placeholder="أدخل نص الزر"
                    oninput="updateTemplatePreview()"
                  />
                </div>
                <div class="wd-form-col button-value">
                  <label for="quickReplyText_${id}">نص الرد</label>
                  <input
                    type="text"
                    id="quickReplyText_${id}"
                    class="wd-form-control"
                    placeholder="أدخل نص الرد"
                    oninput="updateTemplatePreview()"
                  />
                </div>
              </div>
            `;
            break;
        }

        buttonGroup.innerHTML = `
          <div class="wd-button-header">
            ${headerContent}
            <div class="wd-button-actions">
              <button class="wd-button-action delete" onclick="removeButton('${id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          ${fieldsContent}
        `;

        // إضافة أحداث السحب والإفلات
        buttonGroup.addEventListener("dragstart", handleDragStart);
        buttonGroup.addEventListener("dragend", handleDragEnd);
        buttonGroup.addEventListener("dragover", handleDragOver);
        buttonGroup.addEventListener("drop", handleDrop);

        return buttonGroup;
      }

      function handleDragStart(e) {
        e.target.classList.add("dragging");
        e.dataTransfer.setData("text/plain", e.target.id);
      }

      function handleDragEnd(e) {
        e.target.classList.remove("dragging");
      }

      function handleDragOver(e) {
        e.preventDefault();
        const draggingElement = document.querySelector(".dragging");
        const container = document.getElementById("buttonFields");
        const elements = [
          ...container.querySelectorAll(".wd-button-group:not(.dragging)"),
        ];

        const closestElement = elements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = e.clientY - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;

        if (closestElement) {
          container.insertBefore(draggingElement, closestElement);
        } else {
          container.appendChild(draggingElement);
        }
      }

      function handleDrop(e) {
        e.preventDefault();
      }

      function removeButton(id) {
        const buttonGroup = document.getElementById(id);
        const type = id.split("_")[0];
        buttonCounts[type]--;
        buttonCounts.total--;
        buttonGroup.remove();

        // إعادة تفعيل زر الإضافة إذا كان هذا آخر زر من نوعه
        if (buttonCounts[type] === 0) {
          document.getElementById(
            `add${type.charAt(0).toUpperCase() + type.slice(1)}Btn`
          ).disabled = false;
        }

        // إعادة تفعيل جميع أزرار الإضافة إذا كان العدد أقل من 10
        if (buttonCounts.total < 10) {
          if (buttonCounts.phone === 0)
            document.getElementById("addPhoneBtn").disabled = false;
          if (buttonCounts.link < 2)
            document.getElementById("addLinkBtn").disabled = false;
          if (buttonCounts.copy === 0)
            document.getElementById("addCopyBtn").disabled = false;
          document.getElementById("addQuickReplyBtn").disabled = false;
        }

        updateTemplatePreview();
      }

      function addPhoneButton() {
        if (buttonCounts.phone >= 1) {
          alert("يمكنك إضافة زر هاتف واحد فقط");
          return;
        }
        if (buttonCounts.total >= 10) {
          alert("لقد وصلت إلى الحد الأقصى من الأزرار (10 أزرار)");
          disableAllAddButtons();
          return;
        }

        const buttonFields = document.getElementById("buttonFields");
        const id = `phone_${Date.now()}`;
        const buttonGroup = createButtonGroup("phone", id);

        buttonFields.style.display = "block";
        buttonFields.appendChild(buttonGroup);
        buttonCounts.phone++;
        buttonCounts.total++;
        document.getElementById("addPhoneBtn").disabled = true;

        if (buttonCounts.total >= 10) {
          disableAllAddButtons();
        }

        updateTemplatePreview();
      }

      function addLinkButton() {
        if (buttonCounts.link >= 2) {
          alert("يمكنك إضافة زرين رابط فقط");
          return;
        }
        if (buttonCounts.total >= 10) {
          alert("لقد وصلت إلى الحد الأقصى من الأزرار (10 أزرار)");
          disableAllAddButtons();
          return;
        }

        const buttonFields = document.getElementById("buttonFields");
        const id = `link_${Date.now()}`;
        const buttonGroup = createButtonGroup("link", id);

        buttonFields.style.display = "block";
        buttonFields.appendChild(buttonGroup);
        buttonCounts.link++;
        buttonCounts.total++;

        if (buttonCounts.link >= 2) {
          document.getElementById("addLinkBtn").disabled = true;
        }

        if (buttonCounts.total >= 10) {
          disableAllAddButtons();
        }

        updateTemplatePreview();
      }

      function addCopyButton() {
        if (buttonCounts.copy >= 1) {
          alert("يمكنك إضافة زر نسخ رمز واحد فقط");
          return;
        }
        if (buttonCounts.total >= 10) {
          alert("لقد وصلت إلى الحد الأقصى من الأزرار (10 أزرار)");
          disableAllAddButtons();
          return;
        }

        const buttonFields = document.getElementById("buttonFields");
        const id = `copy_${Date.now()}`;
        const buttonGroup = createButtonGroup("copy", id);

        buttonFields.style.display = "block";
        buttonFields.appendChild(buttonGroup);
        buttonCounts.copy++;
        buttonCounts.total++;
        document.getElementById("addCopyBtn").disabled = true;

        if (buttonCounts.total >= 10) {
          disableAllAddButtons();
        }

        updateTemplatePreview();
      }

      function addQuickReplyButton() {
        if (buttonCounts.total >= 10) {
          alert("لقد وصلت إلى الحد الأقصى من الأزرار (10 أزرار)");
          disableAllAddButtons();
          return;
        }

        const buttonFields = document.getElementById("buttonFields");
        const id = `quickReply_${Date.now()}`;
        const buttonGroup = createButtonGroup("quickReply", id);

        buttonFields.style.display = "block";
        buttonFields.appendChild(buttonGroup);
        buttonCounts.quickReply++;
        buttonCounts.total++;

        if (buttonCounts.total >= 10) {
          disableAllAddButtons();
        }

        updateTemplatePreview();
      }

      function disableAllAddButtons() {
        document.getElementById("addPhoneBtn").disabled = true;
        document.getElementById("addLinkBtn").disabled = true;
        document.getElementById("addCopyBtn").disabled = true;
        document.getElementById("addQuickReplyBtn").disabled = true;
      }

      function createTemplate() {
        const name = document.getElementById("templateName").value;
        const type = document.getElementById("templateType").value;
        const language = document.getElementById("templateLanguage").value;
        const content = document.getElementById("templateContent").value;

        // إخفاء جميع رسائل الخطأ
        document
          .querySelectorAll(".wd-error-message")
          .forEach((el) => (el.style.display = "none"));

        let isValid = true;

        if (!name) {
          document.getElementById("templateNameError").style.display = "block";
          document.getElementById("templateNameError").textContent =
            "الرجاء إدخال اسم القالب";
          isValid = false;
        }

        if (!type) {
          document.getElementById("templateTypeError").style.display = "block";
          document.getElementById("templateTypeError").textContent =
            "الرجاء اختيار نوع القالب";
          isValid = false;
        }

        if (!language) {
          document.getElementById("templateLanguageError").style.display =
            "block";
          document.getElementById("templateLanguageError").textContent =
            "الرجاء اختيار لغة القالب";
          isValid = false;
        }

        if (!content) {
          document.getElementById("templateContentError").style.display =
            "block";
          document.getElementById("templateContentError").textContent =
            "الرجاء إدخال محتوى القالب";
          isValid = false;
        }

        if (isValid) {
          // هنا يمكنك إضافة الكود لإنشاء القالب
          alert("تم إنشاء القالب بنجاح");
          window.location.href = "../contents.html";
        }
      }

      function insertVariable(variable) {
        const content = document.getElementById("templateContent");
        const start = content.selectionStart;
        const end = content.selectionEnd;
        const text = content.value;

        content.value =
          text.substring(0, start) + variable + text.substring(end);
        content.selectionStart = content.selectionEnd = start + variable.length;

        updateTemplatePreview();
      }

      function validateTemplateName(input) {
        const value = input.value;
        const errorElement = document.getElementById("templateNameError");
        updateCharCounter(input, "templateNameCounter", 512);

        if (!/^[A-Za-z_]+$/.test(value)) {
          errorElement.style.display = "block";
          errorElement.textContent =
            "يجب أن يحتوي اسم القالب على أحرف إنجليزية و _ فقط";
          input.value = value.replace(/[^A-Za-z_]/g, "");
        } else {
          errorElement.style.display = "none";
        }

        updateTemplatePreview();
      }

      // إضافة دوال جديدة لتحديث العدادات
      function updateCharCounter(input, counterId, maxLength) {
        const count = input.value.length;
        const counter = document.getElementById(counterId);
        counter.textContent = `${count}/${maxLength}`;
        if (count > maxLength) {
          counter.classList.add("error");
        } else {
          counter.classList.remove("error");
        }
      }

      // إضافة مستمعي الأحداث للعدادات
      document.addEventListener("DOMContentLoaded", function () {
        const content = document.getElementById("templateContent");
        const footer = document.getElementById("templateFooter");

        content.addEventListener("input", function () {
          updateCharCounter(this, "templateContentCounter", 1024);
        });

        footer.addEventListener("input", function () {
          updateCharCounter(this, "templateFooterCounter", 60);
        });

        updateTemplatePreview();
      });

      // دالة للحصول على اسم اللغة
      function getLanguageName(code) {
        const languageSelect = document.getElementById("templateLanguage");
        const option = languageSelect.querySelector(`option[value="${code}"]`);
        return option ? option.textContent : "";
      }

      // دالة للحصول على اسم نوع القالب
      function getTemplateTypeName(type) {
        const types = {
          marketing: "MARKETING",
          utility: "UTILITY",
          authentication: "AUTHENTICATION",
          carousel: "CAROUSEL",
        };
        return types[type] || "فئة القالب";
      }

      // تحديث المعاينة عند تغيير نوع القالب
      document
        .getElementById("templateType")
        .addEventListener("change", function () {
          updateTemplatePreview();
        });

      // تحديث المعاينة عند تغيير اللغة
      document
        .getElementById("templateLanguage")
        .addEventListener("change", function () {
          updateTemplatePreview();
        });

      // تحديث المعاينة عند تغيير اسم القالب
      document
        .getElementById("templateName")
        .addEventListener("input", function () {
          updateTemplatePreview();
        });
    </script>
  </body>
</html>
